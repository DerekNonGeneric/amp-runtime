{"version":3,"sources":["node_modules/browser-pack/_prelude.js","src/config.js","src/exponential-backoff.js","src/mode.js","src/service-worker/shell.js","src/service/extension-location.js","src/string.js","src/url-parse-query-string.js","src/worker-error-reporting.js"],"names":[],"mappings":"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","file":"sw.max.js","sourceRoot":"/source/","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Allows for runtime configuration. Internally, the runtime should\n * use the src/config.js module for various constants. We can use the\n * AMP_CONFIG global to translate user-defined configurations to this\n * module.\n * @type {!Object<string, string>}\n */\nconst env = self.AMP_CONFIG || {};\n\nconst thirdPartyFrameRegex = typeof env['thirdPartyFrameRegex'] == 'string' ?\n    new RegExp(env['thirdPartyFrameRegex']) : env['thirdPartyFrameRegex'];\n\nconst cdnProxyRegex = typeof env['cdnProxyRegex'] == 'string' ?\n    new RegExp(env['cdnProxyRegex']) : env['cdnProxyRegex'];\n\n/** @type {!Object<string, string|boolean|RegExp>} */\nexport const urls = {\n  thirdParty: env['thirdPartyUrl'] || 'https://3p.ampproject.net',\n  thirdPartyFrameHost: env['thirdPartyFrameHost'] || 'ampproject.net',\n  thirdPartyFrameRegex: thirdPartyFrameRegex || /^d-\\d+\\.ampproject\\.net$/,\n  cdn: env['cdnUrl'] || 'https://cdn.ampproject.org',\n  cdnProxyRegex: cdnProxyRegex ||\n      /^https:\\/\\/([a-zA-Z0-9_-]+\\.)?cdn\\.ampproject\\.org/,\n  localhostRegex: /^https?:\\/\\/localhost(:\\d+)?$/,\n  errorReporting: env['errorReportingUrl'] ||\n      'https://amp-error-reporting.appspot.com/r',\n  localDev: env['localDev'] || false,\n};\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\n/**\n * @param {number=} opt_base Exponential base. Defaults to 2.\n * @return {function(function()): number} Function that when invoked will\n *     call the passed in function. On every invocation the next\n *     invocation of the passed in function will be exponentially\n *     later. Returned function returns timeout id.\n */\nexport function exponentialBackoff(opt_base) {\n  const getTimeout = exponentialBackoffClock(opt_base);\n  return work => {\n    return setTimeout(work, getTimeout());\n  };\n}\n\n/**\n * @param {number=} opt_base Exponential base. Defaults to 2.\n * @return {function(): number} Function that when invoked will return\n *    a number that exponentially grows per invocation.\n */\nexport function exponentialBackoffClock(opt_base) {\n  const base = opt_base || 2;\n  let count = 0;\n  return () => {\n    let wait = Math.pow(base, count++);\n    wait += getJitter(wait);\n    return wait * 1000;\n  };\n}\n\n/**\n * Add jitter to avoid the thundering herd. This can e.g. happen when\n * we poll a backend and it fails for everyone at the same time.\n * We add up to 30% (default) longer or shorter than the given time.\n *\n * @param {number} wait the amount if base milliseconds\n * @param {number=} opt_perc the min/max percentage to add or sutract\n * @return {number}\n */\nexport function getJitter(wait, opt_perc) {\n  opt_perc = opt_perc || .3;\n  let jitter = wait * opt_perc * Math.random();\n  if (Math.random() > .5) {\n    jitter *= -1;\n  }\n  return jitter;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {startsWith} from './string';\nimport {parseQueryString_} from './url-parse-query-string';\n\n/**\n * @typedef {{\n *   localDev: boolean,\n *   development: boolean,\n *   filter: (string|undefined),\n *   minified: boolean,\n *   lite: boolean,\n *   test: boolean,\n *   log: (string|undefined),\n *   version: string,\n *   rtvVersion: string,\n * }}\n */\nexport let ModeDef;\n\n/** @type {string} */\nconst version = '$internalRuntimeVersion$';\n\n/**\n * `rtvVersion` is the prefixed version we serve off of the cdn.\n * The prefix denotes canary(00) or prod(01) or an experiment version ( > 01).\n * @type {string}\n */\nlet rtvVersion = '';\n\n/**\n * A #querySelector query to see if we have any scripts with development paths.\n * @type {string}\n */\nconst developmentScriptQuery = 'script[src*=\"/dist/\"],script[src*=\"/base/\"]';\n\n/**\n * Provides info about the current app.\n * @param {?Window=} opt_win\n * @return {!ModeDef}\n */\nexport function getMode(opt_win) {\n  const win = opt_win || self;\n  if (win.AMP_MODE) {\n    return win.AMP_MODE;\n  }\n  return win.AMP_MODE = getMode_(win);\n}\n\n/**\n * Provides info about the current app.\n * @param {!Window} win\n * @return {!ModeDef}\n */\nfunction getMode_(win) {\n  // For 3p integration code\n  if (win.context && win.context.mode) {\n    return win.context.mode;\n  }\n\n  // Magic constants that are replaced by closure compiler.\n  // IS_MINIFIED is always replaced with true when closure compiler is used\n  // while IS_DEV is only replaced when the --fortesting flag is NOT used.\n  const IS_DEV = true;\n  const IS_MINIFIED = false;\n  const FORCE_LOCALDEV = !!(self.AMP_CONFIG && self.AMP_CONFIG.localDev);\n  const AMP_CONFIG_3P_FRAME_HOST = self.AMP_CONFIG &&\n      self.AMP_CONFIG.thirdPartyFrameHost;\n\n  const isLocalDev = IS_DEV && !!(win.location.hostname == 'localhost' ||\n      (FORCE_LOCALDEV && win.location.hostname == AMP_CONFIG_3P_FRAME_HOST) ||\n      (win.location.ancestorOrigins && win.location.ancestorOrigins[0] &&\n        startsWith(win.location.ancestorOrigins[0], 'http://localhost:'))) &&\n      // Filter out localhost running against a prod script.\n      // Because all allowed scripts are ours, we know that these can only\n      // occur during local dev.\n      (!win.document || !!win.document.querySelector(developmentScriptQuery));\n\n  const hashQuery = parseQueryString_(\n      // location.originalHash is set by the viewer when it removes the fragment\n      // from the URL.\n      win.location.originalHash || win.location.hash);\n\n  const searchQuery = parseQueryString_(win.location.search);\n\n  if (!rtvVersion) {\n    rtvVersion = getRtvVersion(win, isLocalDev);\n  }\n\n  // The `minified`, `test` and `localDev` properties are replaced\n  // as boolean literals when we run `gulp dist` without the `--fortesting`\n  // flags. This improved DCE on the production file we deploy as the code\n  // paths for localhost/testing/development are eliminated.\n  return {\n    localDev: isLocalDev,\n    // Triggers validation\n    development: !!(hashQuery['development'] == '1' ||\n        win.AMP_DEV_MODE),\n    examiner: hashQuery['development'] == '2',\n    // Allows filtering validation errors by error category. For the\n    // available categories, see ErrorCategory in validator/validator.proto.\n    filter: hashQuery['filter'],\n    minified: IS_MINIFIED,\n    // Whether document is in an amp-lite viewer. It signal that the user\n    // would prefer to use less bandwidth.\n    lite: searchQuery['amp_lite'] != undefined,\n    test: IS_DEV && !!(win.AMP_TEST || win.__karma__),\n    log: hashQuery['log'],\n    version,\n    rtvVersion,\n  };\n}\n\n/**\n * Retrieve the `rtvVersion` which will have a numeric prefix\n * denoting canary/prod/experiment (unless `isLocalDev` is true).\n *\n * @param {!Window} win\n * @param {boolean} isLocalDev\n * @return {string}\n */\nfunction getRtvVersion(win, isLocalDev) {\n  // If it's local dev then we won't actually have a full version so\n  // just use the version.\n  if (isLocalDev) {\n    return version;\n  }\n\n  if (win.AMP_CONFIG && win.AMP_CONFIG.v) {\n    return win.AMP_CONFIG.v;\n  }\n\n  // Currently `$internalRuntimeVersion$` and thus `mode.version` contain only\n  // major version. The full version however must also carry the minor version.\n  // We will default to production default `01` minor version for now.\n  // TODO(erwinmombay): decide whether $internalRuntimeVersion$ should contain\n  // minor version.\n  return `01${version}`;\n}\n\n\n/**\n * @param {!Window} win\n * @param {boolean} isLocalDev\n * @return {string}\n * @visibleForTesting\n */\nexport function getRtvVersionForTesting(win, isLocalDev) {\n  return getRtvVersion(win, isLocalDev);\n}\n\n\n/** @visibleForTesting */\nexport function resetRtvVersionForTesting() {\n  rtvVersion = '';\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getMode} from '../mode';\nimport {calculateExtensionScriptUrl} from '../service/extension-location';\nimport {installWorkerErrorReporting} from '../worker-error-reporting';\n\ninstallWorkerErrorReporting('sw');\n\n/**\n * Import the \"core\" entry point for the AMP CDN Service Worker. This shell\n * file is kept intentionally small, so that checking if it has changed (and\n * thus, if a new SW must be installed) will be very fast.\n */\nconst url = calculateExtensionScriptUrl(self.location, 'cache-service-worker',\n    getMode().localDev);\nimportScripts(url);\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {urls} from '../config';\nimport {getMode} from '../mode';\n\n/**\n * Calculate the base url for any scripts.\n * @param {!Location} location The window's location\n * @param {boolean=} isLocalDev\n * @return {string}\n */\nfunction calculateScriptBaseUrl(location, isLocalDev) {\n  if (isLocalDev) {\n    return `${location.protocol}//${location.host}/dist`;\n  }\n  return urls.cdn;\n}\n\n/**\n * Calculate script url for an extension.\n * @param {!Location} location The window's location\n * @param {string} extensionId\n * @param {boolean=} isLocalDev\n * @return {string}\n */\nexport function calculateExtensionScriptUrl(location, extensionId, isLocalDev) {\n  const base = calculateScriptBaseUrl(location, isLocalDev);\n  return `${base}/rtv/${getMode().rtvVersion}/v0/${extensionId}-0.1.js`;\n}\n\n/**\n * Calculate script url for an entry point.\n * If `opt_rtv` is true, returns the URL matching the current RTV.\n * @param {!Location} location The window's location\n * @param {string} entryPoint\n * @param {boolean=} isLocalDev\n * @param {boolean=} opt_rtv\n * @return {string}\n */\nexport function calculateEntryPointScriptUrl(\n    location, entryPoint, isLocalDev, opt_rtv) {\n  const base = calculateScriptBaseUrl(location, isLocalDev);\n  if (opt_rtv) {\n    return `${base}/rtv/${getMode().rtvVersion}/${entryPoint}.js`;\n  }\n  return `${base}/${entryPoint}.js`;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {string} _match\n * @param {string} character\n * @return {string}\n */\nfunction toUpperCase(_match, character) {\n  return character.toUpperCase();\n}\n\n/**\n * @param {string} name Attribute name with dashes\n * @return {string} Dashes removed and character after to upper case.\n * visibleForTesting\n */\nexport function dashToCamelCase(name) {\n  return name.replace(/-([a-z])/g, toUpperCase);\n}\n\n/**\n * @param {string} name Attribute name with dashes\n * @return {string} Dashes replaced by underlines.\n */\nexport function dashToUnderline(name) {\n  return name.replace('-', '_');\n}\n\n/**\n * Polyfill for String.prototype.endsWith.\n * @param {string} string\n * @param {string} suffix\n * @return {boolean}\n */\nexport function endsWith(string, suffix) {\n  const index = string.length - suffix.length;\n  return index >= 0 && string.indexOf(suffix, index) == index;\n}\n\n/**\n * Polyfill for String.prototype.startsWith.\n * @param {string} string\n * @param {string} prefix\n * @return {boolean}\n */\nexport function startsWith(string, prefix) {\n  if (prefix.length > string.length) {\n    return false;\n  }\n  return string.lastIndexOf(prefix, 0) == 0;\n}\n\n/**\n * Expands placeholders in a given template string with values.\n *\n * Placeholders use ${key-name} syntax and are replaced with the value\n * returned from the given getter function.\n *\n * @param {string} template The template string to expand.\n * @param {!function(string):*} getter Function used to retrieve a value for a\n *   placeholder. Returns values will be coerced into strings.\n * @param {number=} opt_maxIterations Number of times to expand the template.\n *   Defaults to 1, but should be set to a larger value your placeholder tokens\n *   can be expanded to other placeholder tokens. Take caution with large values\n *   as recursively expanding a string can be exponentially expensive.\n */\nexport function expandTemplate(template, getter, opt_maxIterations) {\n  const maxIterations = opt_maxIterations || 1;\n  for (let i = 0; i < maxIterations; i++) {\n    let matches = 0;\n    template = template.replace(/\\${([^}]*)}/g, (_a, b) => {\n      matches++;\n      return getter(b);\n    });\n    if (!matches) {\n      break;\n    }\n  }\n  return template;\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst regex = /(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;\n\n/**\n * Parses the query string of an URL. This method returns a simple key/value\n * map. If there are duplicate keys the latest value is returned.\n *\n * DO NOT import the function from this file. Instead, import parseQueryString\n * from `src/url.js`.\n *\n * @param {string} queryString\n * @return {!JsonObject}\n */\nexport function parseQueryString_(queryString) {\n  const params = /** @type {!JsonObject} */ (Object.create(null));\n  if (!queryString) {\n    return params;\n  }\n\n  let match;\n  while ((match = regex.exec(queryString))) {\n    const name = decodeURIComponent(match[1]).trim();\n    const value = match[2] ? decodeURIComponent(match[2]).trim() : '';\n    params[name] = value;\n  }\n  return params;\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Simplified error reporting for errors in web & service workers.\n */\n\nimport {urls} from './config';\nimport {exponentialBackoff} from './exponential-backoff';\n\n/**\n * Installs error reporting on the `self` global. Error requests contain a\n * URL param \"`tag`=1\" that identifies the originating worker.\n * @param {string} tag\n */\nexport function installWorkerErrorReporting(tag) {\n  /**\n   * Exponential backoff for error reports to avoid any given\n   * worker from generating a very large number of errors.\n   * @const {function(function()): number}\n   */\n  const backoff = exponentialBackoff(1.5);\n\n  self.addEventListener('unhandledrejection', event => {\n    backoff(() => report(event.reason));\n  });\n\n  self.addEventListener('error', event => {\n    backoff(() => report(event.error));\n  });\n\n  /**\n   * Report error to AMP's error reporting frontend.\n   *\n   * @param {*} e\n   */\n  function report(e) {\n    // Don't report local dev errors.\n    if (urls.localhostRegex.test(self.location.origin)) {\n      return;\n    }\n    if (!(e instanceof Error)) {\n      e = new Error(e);\n    }\n    const config = self.AMP_CONFIG || {};\n    const url = urls.errorReporting + '?' +\n        `${tag}=1` + // Tags request as coming from a worker.\n        '&v=' + encodeURIComponent(config.v) +\n        '&m=' + encodeURIComponent(e.message) +\n        '&ca=' + (config.canary ? 1 : 0) +\n        '&s=' + encodeURIComponent(e.stack || '');\n    fetch(url, /** @type {!RequestInit} */ ({\n      // We don't care about the response.\n      mode: 'no-cors',\n    })).catch(reason => {\n      console./*OK*/error(reason);\n    });\n  }\n}\n"]}